<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.kosta.mappers.AdminBookMapper">

<select id="selectMember" resultType="int">
SELECT COUNT(ID) FROM MEMBER WHERE ID=#{id}
</select>

<select id="selectBook" resultType="int">
SELECT COUNT(BNO) FROM room_b WHERE BNO=#{bno} and BRENT=1
</select>

<select id="selectBook2" resultType="int">
SELECT COUNT(BNO) FROM room_b WHERE BNO=#{bno} and BRENT=-1
</select>

<select id="searchID" resultType="String">
SELECT ID FROM RENT_BOOK WHERE BNO=#{bno} AND CHECK_SUBMIT IS FALSE
</select>

<select id="checkLateUser" resultType="int">
SELECT COUNT(id) FROM late WHERE end_date is null and id=#{id}
</select>

<select id="checkLateBook" resultType="boolean">
SELECT check_late FROM rent_book WHERE check_submit = false and bno=#{bno}
</select>

<select id="selectMoney" resultType="String">
SELECT MONEY FROM LATE WHERE end_date is null and bno=#{bno}
</select>

<select id="userInfo" resultType="User_InfoVO">
SELECT * FROM USER_INFO WHERE ID=#{id}
</select>

<select id="rentCnt" parameterType="String" resultType="int">
SELECT COUNT(B.BNO) RCNT
FROM RENT_BOOK R
INNER JOIN BOOK B ON R.BNO=B.BNO 
INNER JOIN ROOM_B RB ON R.BNO=RB.BNO
WHERE RB.BRENT=-1 
AND R.ID=#{id}
AND R.CHECK_SUBMIT = false

</select>

<select id="currentRent" resultType="Rent_BookVO">
SELECT R.RENT_DATE , R.SUBMIT_DATE, B.BTITLE, B.BNO, check_Late, l.money as money
FROM RENT_BOOK R
INNER JOIN BOOK B ON R.BNO=B.BNO 
INNER JOIN ROOM_B RB ON R.BNO=RB.BNO
LEFT JOIN LATE L ON R.BNO=L.BNO 
WHERE RB.BRENT=-1 
AND R.ID=#{id}
AND R.CHECK_SUBMIT = false

</select>

<insert id="insertRent">
INSERT INTO RENT_BOOK(BNO,ID,RENT_DATE,SUBMIT_DATE) 
VALUES(#{bno},#{id},now(),date_add(now(), interval +15 day ))
</insert>

<update id="submitRent">
UPDATE RENT_BOOK SET CHECK_SUBMIT = true WHERE bno = #{bno} 
</update>

<update id="submitLate">
UPDATE LATE SET END_DATE = curdate() WHERE bno = #{bno} 
</update>

<update id="submitRoom_b">
UPDATE ROOM_B SET BRENT = 1 WHERE bno = #{bno} 
</update>

<update id="updateRent">
UPDATE ROOM_B SET BRENT=-1 , BRENT_CNT=BRENT_CNT+1 
WHERE BNO=#{bno}
</update>



<!-- 신규 도서 등록 SQL -->
<sql id="search">
<if test="searchType!=null">
	AND BTITLE LIKE CONCAT('%',#{keyword},'%')
	<if test="searchType=='01'">
		<if test="value=='전체'">
		AND bno LIKE CONCAT(#{searchType},'%')
		</if>
		<if test="value=='시집'">
		AND bno LIKE CONCAT(#{searchType},'01','%')
		</if>
		<if test="value=='산문집'">
		AND bno LIKE CONCAT(#{searchType},'02','%')
		</if>
		<if test="value=='소설'">
		AND bno LIKE CONCAT(#{searchType},'03','%')
		</if>
	</if>
	<if test="searchType=='03'">
		<if test="value=='전체'">
		AND bno LIKE CONCAT(#{searchType},'%')
		</if>
		<if test="value=='프로그래밍'">
		AND bno LIKE CONCAT(#{searchType},'01','%')
		</if>
	</if>
	<if test="searchType=='04'">
		<if test="value=='전체'">
		AND bno LIKE CONCAT(#{searchType},'%')
		</if>
		<if test="value=='정치/외교'">
		AND bno LIKE CONCAT(#{searchType},'01','%')
		</if>
		<if test="value=='생태/환경'">
		AND bno LIKE CONCAT(#{searchType},'02','%')
		</if>
	</if>
	<if test="searchType=='05'">
		<if test="value=='전체'">
		AND bno LIKE CONCAT(#{searchType},'%')
		</if>
		<if test="value=='건축'">
		AND bno LIKE CONCAT(#{searchType},'01','%')
		</if>
	</if>
	<if test="searchType=='07'">
		<if test="value=='전체'">
		AND bno LIKE CONCAT(#{searchType},'%')
		</if>
		<if test="value=='인물'">
		AND bno LIKE CONCAT(#{searchType},'01','%')
		</if>
	</if>
	<if test="searchType=='99'">
		<if test="value=='전체'">
		AND bno LIKE CONCAT(#{searchType},'%')
		</if>
		<if test="value=='베스트일레븐'">
		AND bno LIKE CONCAT(#{searchType},'01','%')
		</if>
		<if test="value=='GAMERZ'">
		AND bno LIKE CONCAT(#{searchType},'02','%')
		</if>
		<if test="value=='PC사랑'">
		AND bno LIKE CONCAT(#{searchType},'03','%')
		</if>
		<if test="value=='GQ코리아'">
		AND bno LIKE CONCAT(#{searchType},'04','%')
		</if>
		<if test="value=='매거진B'">
		AND bno LIKE CONCAT(#{searchType},'05','%')
		</if>
		<if test="value=='위즈키즈'">
		AND bno LIKE CONCAT(#{searchType},'06','%')
		</if>
		<if test="value=='과학소년'">
		AND bno LIKE CONCAT(#{searchType},'07','%')
		</if>
		<if test="value=='더스타'">
		AND bno LIKE CONCAT(#{searchType},'08','%')
		</if>
		<if test="value=='마리끌레르'">
		AND bno LIKE CONCAT(#{searchType},'09','%')
		</if>
		<if test="value=='아망'">
		AND bno LIKE CONCAT(#{searchType},'10','%')
		</if>
		<if test="value=='탑기어'">
		AND bno LIKE CONCAT(#{searchType},'11','%')
		</if>
		<if test="value=='좋은생각'">
		AND bno LIKE CONCAT(#{searchType},'12','%')
		</if>
		<if test="value=='행복이가득한집'">
		AND bno LIKE CONCAT(#{searchType},'13','%')
		</if>
	</if>
</if>
</sql>

<select id="selectBookList" resultType="BookVO">
select * from book
where bLocation=#{bLocation}
<include refid="search"></include>
order by bno desc
limit #{pageStart}, #{perPageNum}
</select>

<!-- 페이징 -->
 <select id="countBookList" resultType="int">
 select count(bno) 
 from book
 where bLocation=#{bLocation}
 
 <include refid="search"></include>
 </select>


</mapper>